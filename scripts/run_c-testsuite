#!/bin/bash -eu

STAGE=$1
CURDIR=$(readlink -f $(dirname $0))
REPOROOT=$(readlink -f ${CURDIR}/..)
PATH="$(readlink -f ${REPOROOT}/target/${STAGE}):${PATH}"

export OUTDIR="$(readlink -f ${REPOROOT}/target/${STAGE}/c-testsuite)"
mkdir -p "${OUTDIR}"

cd ${REPOROOT}
git submodule update --init

cd ${REPOROOT}/external/c-testsuite
if ! [ -d ./.tmsu ]; then
    ./scripts/make-search-index
fi

cp ${REPOROOT}/scripts/gifcc-x86_64 ${REPOROOT}/external/c-testsuite/runners/single-exec/
OUTPUT="${REPOROOT}/target/${STAGE}/c-testsuite/result.tap"
./single-exec gifcc-x86_64 | tee ${OUTPUT} | grep -v '^#'

PASS="$(grep '^ok' ${OUTPUT} | grep -v '# SKIP' | wc -l)"
FAIL="$(grep '^not ok' ${OUTPUT} | wc -l)"
SKIP="$(grep '^ok' ${OUTPUT} | grep '# SKIP' | wc -l)"
TOTAL=$((PASS + FAIL + SKIP))

echo
printf "pass  %5d\n" ${PASS}
printf "fail  %5d\n" ${FAIL}
printf "skip  %5d\n" ${SKIP}
echo "-----------"
printf "total %5d\n" ${TOTAL}

mkdir -p ${REPOROOT}/target/test-results/${STAGE}-c-testsuite
tap-xunit < ${OUTPUT} > ${REPOROOT}/target/test-results/${STAGE}-c-testsuite/results.xml || true

